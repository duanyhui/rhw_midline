# 高级参数调节系统使用说明

## 系统概述

根据您的需求，我为现有的可视化系统添加了一个功能丰富的高级参数调节界面。该系统提供了对ROI投影、最近表面提取、法线可视化、遮挡区域自定义以及引导中心线等所有关键参数的精细调节能力。

## 功能特性

### 🎛️ 分类参数调节
- **ROI投影参数**：ROI模式选择、相机矩形ROI、像素尺寸、边界扩展等
- **最近表面参数**：平面展平、RANSAC参数、Z选择模式、分位数设置、形态学处理等  
- **法线可视化参数**：法向采样线显示、箭头间距、调试窗口、法线长度等
- **遮挡区域参数**：遮挡区域开关、多边形定义、扩张距离、环带合成等
- **引导中心线参数**：基础参数、平滑参数、梯度控制、拐角处理等

### 🔍 实时预览功能
- **参数预览**：修改参数后可立即预览效果
- **参数应用**：确认参数无误后一键应用到主系统
- **参数重置**：一键恢复到对话框打开时的参数值

### 💾 参数管理
- **预设保存**：可将当前参数组合保存为预设文件
- **预设加载**：快速加载之前保存的参数预设
- **参数导出**：支持将参数配置导出为JSON格式

## 文件结构

```
gui/
├── simple_advanced_params.py           # 简化版高级参数对话框（主要文件）
├── advanced_params_dialog.py           # 完整版高级参数对话框（高级版）
├── advanced_params_methods.py          # 高级参数方法扩展
├── advanced_params_utils.py            # 高级参数工具函数
└── main.py                             # 主界面（已添加高级参数按钮）
```

## 使用方法

### 1. 打开高级参数调节界面

在主界面底部操作区域，点击绿色的 **"高级参数调节"** 按钮即可打开高级参数调节窗口。

### 2. 参数调节操作

#### ROI投影选项卡
- **ROI模式**：选择none、camera_rect、machine、gcode_bounds等模式
- **相机矩形ROI**：当选择camera_rect模式时，设置X、Y坐标及宽度、高度
- **投影参数**：调节像素尺寸和边界扩展距离

#### 最近表面选项卡
- **平面展平**：开启/关闭平面展平，调节RANSAC阈值和迭代次数
- **表面提取**：设置Z选择模式、分位数范围、深度边界
- **形态学处理**：配置开运算、闭运算核大小和最小连通域

#### 法线可视化选项卡
- **法线显示**：控制法向采样线的显示和箭头间距
- **调试窗口**：配置法线调试窗口的各项参数
- **文本标注**：开启/关闭Δn数值的文本显示

#### 遮挡区域选项卡
- **遮挡设置**：启用遮挡区域检测和设置扩张距离
- **多边形定义**：使用文本方式定义遮挡区域的多边形轮廓
- **环带合成**：在遮挡区域内按G代码合成环带掩码

#### 引导中心线选项卡
- **基础参数**：引导步长、搜索半宽、最大偏移限制
- **平滑参数**：平滑窗口、曲率自适应、敏感度调节
- **梯度控制**：最大梯度限制、缺口处理
- **拐角处理**：拐角忽略功能和相关参数

### 3. 参数预览和应用

1. **实时预览**：修改任何参数后，点击"预览效果"按钮可立即查看参数变化的影响
2. **参数应用**：确认参数设置满意后，点击"应用"按钮将参数保存到主系统
3. **参数重置**：如需撤销修改，点击"重置"按钮恢复原始参数
4. **取消操作**：点击"取消"按钮关闭对话框，不保存任何修改

### 4. 参数预设管理

- **保存预设**：在"保存预设"按钮点击后，选择保存位置，将当前参数组合保存为JSON文件
- **加载预设**：点击"加载预设"按钮，选择之前保存的预设文件快速恢复参数配置

## 参数说明

### 关键参数详解

#### ROI投影参数
- **像素尺寸(mm)**：决定投影分辨率，值越小精度越高但计算量越大
- **边界扩展(mm)**：在G代码边界基础上的扩展距离

#### 最近表面参数
- **RANSAC阈值(mm)**：平面拟合的内点判断阈值，影响平面拟合质量
- **分位数设置**：控制最近表面的提取范围，通常下界1%，上界95-99%
- **深度边界(mm)**：相对参考层的厚度范围

#### 法线可视化参数
- **箭头间距**：控制偏差箭头的显示密度，值越大显示越稀疏
- **法线长度(mm)**：调试窗口中法线的显示长度，0表示自动

#### 引导中心线参数
- **引导步长(mm)**：G代码重采样的步长，影响精度和计算量
- **搜索半宽(mm)**：法向搜索的半径范围
- **最大梯度(mm/mm)**：相邻点偏差变化的限制，防止突变

## 应用场景

### 1. 精度优化场景
当加工精度要求很高时，可以：
- 减小像素尺寸提高分辨率
- 优化RANSAC参数提高平面拟合精度
- 调节搜索半宽平衡精度与稳定性

### 2. 复杂工件场景  
对于复杂几何形状的工件：
- 启用曲率自适应平滑
- 调节拐角处理参数
- 优化形态学处理参数

### 3. 遮挡环境场景
当存在固定遮挡物时：
- 精确定义遮挡区域多边形
- 启用环带合成功能
- 调节扩张距离确保完全覆盖

### 4. 调试分析场景
进行算法调试和分析时：
- 启用法线调试窗口
- 显示Δn文本标注
- 调节可视化参数便于观察

## 注意事项

### ⚠️ 重要提醒

1. **参数相互影响**：某些参数之间存在相互影响，建议逐步调节并及时预览效果
2. **计算性能**：像素尺寸、RANSAC迭代次数等参数直接影响计算时间
3. **精度平衡**：过高的精度设置可能导致噪声敏感性增加
4. **预设管理**：建议为不同应用场景保存对应的参数预设

### 🔧 最佳实践

1. **渐进调节**：建议先使用默认参数，然后根据实际效果逐步微调
2. **场景预设**：为常用的加工场景创建专门的参数预设
3. **效果验证**：每次参数调节后都要通过预览验证效果
4. **备份重要**：重要的参数组合要及时保存为预设文件

## 技术实现

### 架构设计
- **模块化设计**：各个参数类别独立成选项卡，便于使用和维护
- **信号机制**：使用PyQt信号机制实现参数变化的实时响应
- **预览系统**：通过临时应用参数的方式实现预览功能

### 扩展性
系统设计时充分考虑了扩展性：
- 新参数可通过增加控件轻松添加
- 新的参数类别可通过增加选项卡实现
- 预设格式支持版本控制和兼容性

---

## 总结

这个高级参数调节系统为您的可视化系统提供了强大而灵活的参数调节能力。通过分类组织的界面设计、实时预览功能和便捷的预设管理，用户可以轻松地针对不同应用场景优化系统参数，大大提升了系统的适用性和易用性。

系统完全集成到现有界面中，通过一个按钮即可切换，既保持了原有界面的简洁性，又提供了专业用户所需的高级功能。