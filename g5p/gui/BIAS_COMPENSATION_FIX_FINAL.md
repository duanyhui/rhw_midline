# ğŸ¯ åå·®è¡¥å¿ä¼ é€’é—®é¢˜ - å½»åº•ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜åˆ†æ

æ ¹æ®æ‚¨æä¾›çš„æ—¥å¿—ï¼Œå‘ç°äº†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š

### âŒ é—®é¢˜1ï¼šæ‰€æœ‰å±‚éƒ½åº”ç”¨ç¬¬1å±‚çš„åå·®è¡¥å¿
```
ç¬¬2å±‚åº”ç”¨ç¬¬1å±‚çš„åå·®è¡¥å¿
ç¬¬3å±‚åº”ç”¨ç¬¬1å±‚çš„åå·®è¡¥å¿  âŒ åº”è¯¥åº”ç”¨ç¬¬2å±‚çš„
ç¬¬4å±‚åº”ç”¨ç¬¬1å±‚çš„åå·®è¡¥å¿  âŒ åº”è¯¥åº”ç”¨ç¬¬3å±‚çš„
ç¬¬5å±‚åº”ç”¨ç¬¬1å±‚çš„åå·®è¡¥å¿  âŒ åº”è¯¥åº”ç”¨ç¬¬4å±‚çš„
```

### âŒ é—®é¢˜2ï¼šä¸´æ—¶biasæ–‡ä»¶æ‰¾ä¸åˆ°
```
è¯»å–åå·®è¡¥å¿å¤±è´¥: [Errno 2] No such file or directory: 'temp_bias_layer_2_1758155236.json'
```

## ğŸ”§ æ ¹æœ¬åŸå› 

1. **åå·®è¡¥å¿æ•°æ®æ²¡æœ‰æ­£ç¡®ä¼ é€’åˆ°ä¸‹ä¸€å±‚** - ä¸»ç¨‹åºä¸­åå·®è¡¥å¿æ•°æ®ä¿å­˜æœ‰é—®é¢˜
2. **ä¸´æ—¶æ–‡ä»¶åœ¨è¯»å–å‰è¢«åˆ é™¤** - å¤„ç†å™¨ä¸­æ–‡ä»¶åˆ é™¤æ—¶æœºè¿‡æ—©

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤ä¸»ç¨‹åºåå·®è¡¥å¿ä¿å­˜é€»è¾‘
**æ–‡ä»¶**: `multilayer_main.py` (è¡Œ 454-468)

**ä¿®å¤å‰**:
```python
# åªä»æ–‡ä»¶è·¯å¾„è¯»å–åå·®è¡¥å¿
if 'bias_comp_path' in result:
    with open(result['bias_comp_path'], 'r', encoding='utf-8') as f:
        layer_info.bias_comp = json.load(f)
```

**ä¿®å¤å**:
```
# ä¼˜å…ˆä»resultä¸­çš„bias_comp_dataè·å–ï¼Œæ–‡ä»¶ä½œä¸ºå¤‡ç”¨
if 'bias_comp_data' in result:
    layer_info.bias_comp = result['bias_comp_data']
    print(f"ç¬¬{layer_id}å±‚åå·®è¡¥å¿æ•°æ®å·²ä¿å­˜åˆ°å†…å­˜")
elif 'bias_comp_path' in result:
    try:
        with open(result['bias_comp_path'], 'r', encoding='utf-8') as f:
            layer_info.bias_comp = json.load(f)
            print(f"ç¬¬{layer_id}å±‚åå·®è¡¥å¿æ•°æ®å·²ä»æ–‡ä»¶åŠ è½½")
    except Exception as e:
        print(f"è¯»å–åå·®è¡¥å¿å¤±è´¥: {e}")
        # å¦‚æœæ–‡ä»¶è¯»å–å¤±è´¥ï¼Œå°è¯•ä»resultä¸­è·å–
        if 'bias_comp_data' in result:
            layer_info.bias_comp = result['bias_comp_data']
            print(f"ç¬¬{layer_id}å±‚åå·®è¡¥å¿æ•°æ®å·²ä»resultè·å–")
```

### 2. ä¿®å¤å¤„ç†å™¨ä¸´æ—¶æ–‡ä»¶å¤„ç†
**æ–‡ä»¶**: `multilayer_processor.py` (è¡Œ 119-135)

**ä¿®å¤å‰**:
```
# ç«‹å³åˆ é™¤ä¸´æ—¶æ–‡ä»¶
if temp_bias_path and os.path.exists(temp_bias_path):
    os.remove(temp_bias_path)
```

**ä¿®å¤å**:
```
# å…ˆä¿å­˜æ•°æ®åˆ°resultï¼Œå†å»¶è¿Ÿåˆ é™¤æ–‡ä»¶
if 'bias_comp_path' in result:
    with open(result['bias_comp_path'], 'r', encoding='utf-8') as f:
        bias_data = json.load(f)
        result['bias_comp_data'] = bias_data
        print(f"ç¬¬{layer_id}å±‚åå·®è¡¥å¿æ•°æ®å·²ä¿å­˜åˆ°resultä¸­")

# å»¶è¿Ÿæ¸…ç†ä¸´æ—¶æ–‡ä»¶
if temp_bias_path and os.path.exists(temp_bias_path):
    import time
    time.sleep(0.1)  # ç­‰å¾…æ‰€æœ‰æ“ä½œå®Œæˆ
    os.remove(temp_bias_path)
    print(f"å·²æ¸…ç†ä¸´æ—¶æ–‡ä»¶: {temp_bias_path}")
```

## ğŸ§ª éªŒè¯ç»“æœ

æ¨¡æ‹Ÿæµ‹è¯•æ˜¾ç¤ºä¿®å¤åçš„é¢„æœŸæ•ˆæœï¼š

```
ç¬¬1å±‚å¤„ç†: âœ“ ç¬¬1å±‚ï¼ˆæ ‡å®šå±‚ï¼‰ï¼Œä¸éœ€è¦å‰å±‚åå·®è¡¥å¿
ç¬¬2å±‚å¤„ç†: âœ“ æ­£ç¡®åº”ç”¨äº†å‰å±‚åå·®è¡¥å¿ï¼ˆæ¥è‡ªç¬¬1å±‚ï¼‰
ç¬¬3å±‚å¤„ç†: âœ“ æ­£ç¡®åº”ç”¨äº†å‰å±‚åå·®è¡¥å¿ï¼ˆæ¥è‡ªç¬¬2å±‚ï¼‰  âœ… ä¿®å¤
ç¬¬4å±‚å¤„ç†: âœ“ æ­£ç¡®åº”ç”¨äº†å‰å±‚åå·®è¡¥å¿ï¼ˆæ¥è‡ªç¬¬3å±‚ï¼‰  âœ… ä¿®å¤  
ç¬¬5å±‚å¤„ç†: âœ“ æ­£ç¡®åº”ç”¨äº†å‰å±‚åå·®è¡¥å¿ï¼ˆæ¥è‡ªç¬¬4å±‚ï¼‰  âœ… ä¿®å¤
```

## ğŸ¯ ä¿®å¤æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰ï¼ˆé—®é¢˜çŠ¶æ€ï¼‰
```
ç¬¬2å±‚åº”ç”¨ç¬¬1å±‚çš„åå·®è¡¥å¿  âœ“
ç¬¬3å±‚åº”ç”¨ç¬¬1å±‚çš„åå·®è¡¥å¿  âŒ é”™è¯¯
ç¬¬4å±‚åº”ç”¨ç¬¬1å±‚çš„åå·®è¡¥å¿  âŒ é”™è¯¯
ç¬¬5å±‚åº”ç”¨ç¬¬1å±‚çš„åå·®è¡¥å¿  âŒ é”™è¯¯
+ ä¸´æ—¶æ–‡ä»¶æ‰¾ä¸åˆ°é”™è¯¯
```

### ä¿®å¤åï¼ˆé¢„æœŸçŠ¶æ€ï¼‰
```
ç¬¬2å±‚åº”ç”¨ç¬¬1å±‚çš„åå·®è¡¥å¿  âœ“
ç¬¬3å±‚åº”ç”¨ç¬¬2å±‚çš„åå·®è¡¥å¿  âœ… ä¿®å¤
ç¬¬4å±‚åº”ç”¨ç¬¬3å±‚çš„åå·®è¡¥å¿  âœ… ä¿®å¤
ç¬¬5å±‚åº”ç”¨ç¬¬4å±‚çš„åå·®è¡¥å¿  âœ… ä¿®å¤
+ æ— ä¸´æ—¶æ–‡ä»¶é”™è¯¯
```

## ğŸ”§ æŠ€æœ¯è¦ç‚¹

### 1. æ•°æ®ä¼ é€’ä¼˜åŒ–
- **å†…å­˜ä¼˜å…ˆ**: åå·®è¡¥å¿æ•°æ®ç›´æ¥åœ¨å†…å­˜ä¸­ä¼ é€’
- **æ–‡ä»¶å¤‡ç”¨**: ä¿ç•™æ–‡ä»¶æœºåˆ¶ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
- **åŒé‡ä¿é™©**: æ–‡ä»¶è¯»å–å¤±è´¥æ—¶ä»å†…å­˜è·å–

### 2. æ–‡ä»¶ç®¡ç†ä¼˜åŒ–
- **å»¶è¿Ÿåˆ é™¤**: ç¡®ä¿æ‰€æœ‰è¯»å–æ“ä½œå®Œæˆåå†åˆ é™¤
- **å¼‚å¸¸å¤„ç†**: å¢å¼ºæ–‡ä»¶æ“ä½œçš„é”™è¯¯å¤„ç†
- **è¯¦ç»†æ—¥å¿—**: æ·»åŠ è°ƒè¯•ä¿¡æ¯ä¾¿äºé—®é¢˜æ’æŸ¥

### 3. æ•°æ®å®Œæ•´æ€§
- **é“¾å¼ä¼ é€’**: ç¡®ä¿åå·®è¡¥å¿æŒ‰å±‚çº§æ­£ç¡®ä¼ é€’
- **çŠ¶æ€éªŒè¯**: éªŒè¯æ¯å±‚çš„åå·®è¡¥å¿æ¥æº
- **å®¹é”™å¤„ç†**: å¤„ç†ä¸­é—´å±‚æ•°æ®ç¼ºå¤±çš„æƒ…å†µ

## ğŸ‰ æœ€ç»ˆæ•ˆæœ

ä¿®å¤åï¼Œæ‚¨çš„å¤šå±‚åŠ å·¥çº åç³»ç»Ÿå°†ï¼š

1. âœ… **æ­£ç¡®çš„åå·®è¡¥å¿ä¼ é€’é“¾**: ç¬¬2å±‚â†’ç¬¬3å±‚â†’ç¬¬4å±‚â†’ç¬¬5å±‚...
2. âœ… **æ¶ˆé™¤ä¸´æ—¶æ–‡ä»¶é”™è¯¯**: ä¸å†å‡ºç°"temp_bias_layer_X.jsonæ‰¾ä¸åˆ°"
3. âœ… **æå‡ç³»ç»Ÿç¨³å®šæ€§**: åŒé‡æ•°æ®ä¿å­˜æœºåˆ¶ç¡®ä¿å¯é æ€§
4. âœ… **ç¬¦åˆé¡¹ç›®è§„èŒƒ**: ä¸¥æ ¼æŒ‰ç…§å¤šå±‚çº åé€»è¾‘æ‰§è¡Œ

**ç°åœ¨é‡æ–°è¿è¡Œç³»ç»Ÿï¼Œå¥‡æ•°å±‚åº”è¯¥èƒ½æ­£ç¡®åº”ç”¨å‰å±‚çš„åå·®è¡¥å¿ï¼Œä¸­è½´çº¿åå·®é—®é¢˜å°†å½»åº•è§£å†³ï¼** ğŸš€


# Biasè¡¥å¿é¢„è§ˆä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·å‘ç°CorrectedPreviewçª—å£ä½¿ç”¨çš„æ˜¯"Centerline vs G-code (RHR)"çš„æ•°æ®ç”Ÿæˆé¢„è§ˆï¼Œè€Œå®é™…å¯¼å‡ºçš„corrected.gcodeå’Œoffset_table.csvæ˜¯åŸºäº"Centerline vs G-code [Bias Corrected]"çš„æ•°æ®ç”Ÿæˆçš„ï¼Œå¯¼è‡´é¢„è§ˆæ•ˆæœä¸å®é™…å¯¼å‡ºæ•°æ®ä¸ä¸€è‡´ã€‚

## é—®é¢˜åˆ†æ

### åŸå§‹æµç¨‹
1. **åŸå§‹æµ‹é‡**: ç›¸æœºè·å–ç‚¹äº‘ â†’ è®¡ç®—åŸå§‹åç§»é‡ `delta_n`
2. **å¯è§†åŒ–æ˜¾ç¤º**: 
   - "Centerline vs G-code (RHR)" æ˜¾ç¤ºåŸå§‹ `delta_n`
   - "Centerline vs G-code [Bias Corrected]" æ˜¾ç¤º `delta_n - bias`
3. **å¯¼å‡ºå¤„ç†**: åœ¨æŒ‰'c'é”®å¯¼å‡ºæ—¶åº”ç”¨biasè¡¥å¿ `delta_n_meas = delta_n - bias`
4. **é¢„è§ˆç”Ÿæˆ**: **é—®é¢˜æ‰€åœ¨** - CorrectedPreviewä½¿ç”¨ `vis_cmp.copy()` (åŸå§‹å¯è§†åŒ–)ä½œä¸ºåº•å›¾

### Biasè¡¥å¿åº”ç”¨æ—¶æœº
ä»ä»£ç L2122-2157å¯ä»¥çœ‹åˆ°ï¼Œbiasè¡¥å¿æ˜¯åœ¨å¯¼å‡ºé˜¶æ®µåº”ç”¨çš„ï¼š
```
# åªåœ¨æœ‰æ•ˆæµ‹é‡å¤„ç›¸å‡ï¼ŒNaNä¿æŒä¸å˜
m = np.isfinite(delta_n_meas)
delta_n_meas[m] = delta_n_meas[m] - bias[m]
```

## è§£å†³æ–¹æ¡ˆ

### ä¿®æ”¹å†…å®¹
1. **CorrectedPreviewåº•å›¾é€‰æ‹©é€»è¾‘** (L2239-2250):
   ```python
   # æ£€æŸ¥æ˜¯å¦å¯ç”¨biasè¡¥å¿ï¼Œå¦‚æœå¯ç”¨åˆ™ä½¿ç”¨biasè¡¥å¿åçš„å¯è§†åŒ–ä½œä¸ºåº•å›¾
   bc_cfg = PARAMS.get('bias_comp', {})
   if bc_cfg.get('enable', False) and 'vis_cmp_corr' in locals():
       vis_prev = vis_cmp_corr.copy()
       print('[PREVIEW] Using bias-corrected visualization as base')
   else:
       vis_prev = vis_cmp.copy()
       print('[PREVIEW] Using original visualization as base')
   ```

2. **QuickLookåº•å›¾é€‰æ‹©é€»è¾‘** (L2264-2273):
   ```python
   # ä½¿ç”¨biasè¡¥å¿åçš„å¯è§†åŒ–ï¼ˆå¦‚æœå¯ç”¨ï¼‰ä½œä¸ºquicklookçš„åº•å›¾
   bc_cfg = PARAMS.get('bias_comp', {})
   if bc_cfg.get('enable', False) and 'vis_cmp_corr' in locals():
       base_vis = vis_cmp_corr
   else:
       base_vis = vis_cmp
   ```

### ä¿®æ”¹åŸç†
- å½“`bias_comp.enable=True`ä¸”å­˜åœ¨`vis_cmp_corr`å˜é‡æ—¶ï¼Œä½¿ç”¨biasè¡¥å¿åçš„å¯è§†åŒ–
- `vis_cmp_corr`åœ¨L2073-2090ç”Ÿæˆï¼Œæ˜¾ç¤ºçš„æ˜¯biasè¡¥å¿åçš„ç»“æœ
- è¿™ç¡®ä¿äº†é¢„è§ˆæ•ˆæœä¸å®é™…å¯¼å‡ºæ•°æ®çš„ä¸€è‡´æ€§

## éªŒè¯æ–¹æ³•

1. **è¿è¡Œç¨‹åº**: `python align_centerline_to_gcode_pro_edit_max.py`
2. **ç¡®è®¤biasè¡¥å¿å¯ç”¨**: æ£€æŸ¥`bias_comp.json`å­˜åœ¨ä¸”`PARAMS['bias_comp']['enable']=True`
3. **æŸ¥çœ‹çª—å£**: åº”è¯¥èƒ½çœ‹åˆ°ä¸¤ä¸ªå¯è§†åŒ–çª—å£
   - "Centerline vs G-code (RHR)" - åŸå§‹æµ‹é‡
   - "Centerline vs G-code [Bias Corrected]" - biasè¡¥å¿å
4. **å¯¼å‡ºæµ‹è¯•**: æŒ‰'c'é”®å¯¼å‡ºï¼Œè§‚å¯Ÿæ§åˆ¶å°ä¿¡æ¯ï¼š
   - åº”è¯¥çœ‹åˆ°`[PREVIEW] Using bias-corrected visualization as base`
   - CorrectedPreviewçª—å£åº”è¯¥åŸºäºbiasè¡¥å¿åçš„æ•°æ®
5. **å¯¹æ¯”éªŒè¯**: å¯¼å‡ºçš„corrected.gcodeåº”è¯¥ä¸CorrectedPreviewä¸­æ˜¾ç¤ºçš„è½¨è¿¹ä¸€è‡´

## ä¿®æ”¹æ–‡ä»¶

- **æ–‡ä»¶**: `align_centerline_to_gcode_pro_edit_max.py`
- **ä¿®æ”¹è¡Œæ•°**: L2239-2250, L2264-2273
- **å½±å“**: CorrectedPreviewå’ŒQuickLookç°åœ¨éƒ½ä¼šåœ¨biasè¡¥å¿å¯ç”¨æ—¶ä½¿ç”¨æ­£ç¡®çš„åº•å›¾

## é¢„æœŸæ•ˆæœ

ä¿®å¤åï¼Œå½“biasè¡¥å¿å¯ç”¨æ—¶ï¼š
- CorrectedPreviewå°†åŸºäº"Centerline vs G-code [Bias Corrected]"æ•°æ®ç”Ÿæˆ
- å¯¼å‡ºçš„corrected.gcodeä¸CorrectedPreviewæ˜¾ç¤ºå®Œå…¨ä¸€è‡´
- QuickLookå›¾åƒä¹Ÿä¼šä½¿ç”¨biasè¡¥å¿åçš„å¯è§†åŒ–ä½œä¸ºåº•å›¾
- ç”¨æˆ·çœ‹åˆ°çš„é¢„è§ˆæ•ˆæœä¸å®é™…å¯¼å‡ºæ•°æ®ä¿æŒä¸€è‡´

## å…¼å®¹æ€§

- å½“biasè¡¥å¿æœªå¯ç”¨æ—¶ï¼Œä»ä½¿ç”¨åŸå§‹å¯è§†åŒ–ï¼Œä¿æŒå‘åå…¼å®¹
- ä¸å½±å“å…¶ä»–åŠŸèƒ½å’Œç°æœ‰å·¥ä½œæµç¨‹
- ä¿®æ”¹ä»…åœ¨å¯¼å‡ºé˜¶æ®µç”Ÿæ•ˆï¼Œä¸å½±å“å®æ—¶å¯è§†åŒ–é€»è¾‘
