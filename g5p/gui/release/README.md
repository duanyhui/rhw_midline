# 多层加工纠偏系统 - 真实PLC通信的可视化算法程序

## 项目简介

本项目是一个工业级的多层加工纠偏系统，实现了真实PLC通信功能的可视化算法程序。系统支持逐层加工、偏差补偿累积、实时PLC通信、3D可视化等功能，适用于精密制造、增材制造等应用场景。

## 核心功能

- **多层加工处理**：支持逐层G代码加工，自动偏差检测和纠偏
- **真实PLC通信**：支持S7协议、TCP协议、模拟器等多种通信方式
- **算法可视化**：实时显示加工轨迹、偏差分析、纠偏效果
- **分层偏差补偿**：支持层间偏差累积补偿，提高加工精度
- **安全监控**：完整的质量门槛和安全检查机制

## 文件说明

### 主程序文件

#### multilayer_main.py
- **作用**：多层加工纠偏系统的主程序入口和GUI界面
- **功能**：
  - 提供完整的用户界面，支持项目配置、PLC通信设置
  - 集成相机控制、G代码加载、层管理功能
  - 实现PLC状态监控和自动处理流程
  - 支持高级参数调节和可视化展示z
- **关键特性**：
  - 智能PLC连接切换（S7↔TCP↔模拟器）
  - 完整的错误处理和状态同步机制
  - 支持批量处理和单层处理模式

#### run_multilayer_system.py
- **作用**：系统启动脚本
- **功能**：
  - 检查依赖包完整性
  - 设置工作目录和配置环境
  - 启动多层加工纠偏系统
- **使用**：直接运行此脚本启动完整系统

### PLC通信模块

#### multilayer_plc.py
- **作用**：PLC通信基础模块
- **功能**：
  - 定义PLC通信协议和基类
  - 实现TCP、S7、模拟器等多种通信方式
  - 提供统一的PLC数据交换接口
  - 支持连接状态管理和错误恢复
- **支持协议**：
  - TCP JSON协议（用于模拟器和简单PLC）
  - S7协议（基于snap7库）
  - Mock模拟器（用于测试）

#### s7_plc_enhanced.py
- **作用**：增强的S7协议PLC通信器
- **功能**：
  - 实现完整的S7协议通信
  - 支持大数据量分批传输
  - 提供心跳监控和安全检查
  - 智能连接切换和错误恢复
- **特性**：
  - 自动检测连接类型并切换到最佳模式
  - 支持数据锁机制，确保传输安全
  - 完整的传输进度反馈

#### plc_data_structures.py
- **作用**：PLC数据块结构定义
- **功能**：
  - 定义西门子S7协议数据块结构
  - 提供控制块和偏移数据块管理
  - 实现数据序列化和反序列化
  - 支持数据验证和格式转换

#### offset_data_handler.py
- **作用**：偏移数据处理和分批传输模块
- **功能**：
  - 处理offset_table.csv偏移数据
  - 实现数据验证、过滤和安全检查
  - 支持分批传输到PLC
  - 提供数据质量评估和插值补全

### 算法处理模块

#### multilayer_processor.py
- **作用**：多层处理线程模块
- **功能**：
  - 实现单层和批量处理线程
  - 管理偏差补偿逻辑和层间数据传递
  - 生成处理结果和质量指标
  - 创建独立的层输出目录
- **处理流程**：
  - 第1层：标定模式，不应用偏差补偿
  - 第2+层：应用前层偏差补偿，生成纠偏数据

#### align_centerline_to_gcode_pro_edit_max.py
- **作用**：核心算法模块
- **功能**：
  - 实现G代码引导的中轴线检测算法
  - 提供相机采图、3D重建、轨迹分析
  - 支持偏差计算和纠偏G代码生成
  - 包含完整的质量评估和可视化功能
- **算法特性**：
  - 严格一一对应的轨迹映射
  - 梯度门限抑制抖动
  - 曲率自适应平滑处理

#### controller.py
- **作用**：算法控制器（旧GUI复用模块）
- **功能**：
  - 封装核心算法调用接口
  - 提供相机控制和图像处理
  - 管理配置参数和结果导出
  - 支持偏差补偿和batch处理

### 可视化和界面模块

#### multilayer_visualizer.py
- **作用**：可视化组件和高级参数调节界面
- **功能**：
  - 提供多种可视化模式（轨迹对比、误差分析等）
  - 实现高级参数调节对话框
  - 支持图像导出和结果展示
  - 提供统计对比和质量分析界面
- **可视化模式**：
  - 原始vs理论轨迹对比
  - 纠偏后效果展示
  - 误差分布和统计分析
  - G代码3D可视化

### 数据结构模块

#### multilayer_data.py
- **作用**：系统数据结构定义
- **功能**：
  - 定义LayerInfo、ProjectConfig等核心数据结构
  - 提供配置序列化和反序列化
  - 支持项目配置管理和数据验证
- **数据结构**：
  - LayerInfo：单层信息管理
  - ProjectConfig：项目全局配置
  - ProcessingMetrics：处理质量指标

### 兼容性文件

#### main.py
- **作用**：旧GUI主程序（作为依赖保留）
- **功能**：
  - 提供基础的GUI界面
  - 兼容旧版本配置和调用方式
  - 作为controller.py的运行环境

#### run_gui.py
- **作用**：旧版GUI启动脚本
- **功能**：
  - 启动旧版GUI界面
  - 设置路径和环境变量
  - 用于兼容性测试

## 系统架构

```
多层加工纠偏系统
├── 用户界面层 (multilayer_main.py, multilayer_visualizer.py)
├── 业务逻辑层 (multilayer_processor.py, controller.py)
├── 算法核心层 (align_centerline_to_gcode_pro_edit_max.py)
├── 通信协议层 (multilayer_plc.py, s7_plc_enhanced.py)
├── 数据管理层 (plc_data_structures.py, offset_data_handler.py)
└── 配置数据层 (multilayer_data.py)
```

## 技术特性

### PLC通信特性
- **多协议支持**：S7、TCP、模拟器
- **智能切换**：自动检测并选择最佳连接方式
- **分批传输**：支持大数据量分批发送（384点/批次）
- **安全机制**：数据锁、心跳监控、错误恢复
- **实时监控**：状态同步、进度反馈、质量检查

### 算法特性
- **高精度**：严格一一对应的轨迹映射
- **鲁棒性**：梯度门限、曲率自适应、异常检测
- **实时性**：多线程处理、增量计算
- **可视化**：多种视图模式、实时反馈

### 系统特性
- **模块化**：清晰的分层架构，便于维护扩展
- **工业级**：完整的错误处理、日志记录、质量保证
- **用户友好**：直观的界面、详细的状态提示
- **配置灵活**：支持参数调节、预设保存

## 运行要求

### 必需依赖
- Python 3.7+
- PyQt5
- NumPy
- OpenCV (cv2)

### 可选依赖
- python-snap7 (S7通信)
- pcammls (相机SDK)

### 硬件要求
- 3D相机（支持点云采集）
- PLC设备（西门子S7或兼容设备）
- 工控机或高性能PC

## 使用说明

### 快速启动
1. 确保安装所有依赖包
2. 运行 `python run_multilayer_system.py` 启动系统
3. 配置PLC连接参数和项目设置
4. 加载G代码文件，开始多层加工

### 配置说明
- **项目配置**：设置层数、层厚、自动模式等
- **PLC配置**：选择通信类型、IP地址、数据块地址
- **算法配置**：调节引导参数、质量门槛等
- **可视化配置**：选择显示模式、导出选项

### 操作流程
1. **项目初始化**：创建项目，设置基本参数
2. **G代码加载**：加载所有层的G代码文件
3. **PLC连接**：建立与PLC的通信连接
4. **逐层处理**：
   - 第1层：标定，建立基准
   - 第2+层：应用补偿，生成纠偏数据
5. **结果导出**：查看可视化结果，导出纠偏数据

## 开发说明

### 扩展指南
- **新增通信协议**：继承PLCCommunicator基类
- **算法优化**：修改align_centerline_to_gcode_pro_edit_max.py
- **界面定制**：扩展multilayer_visualizer.py
- **数据格式**：调整multilayer_data.py结构定义

### 调试技巧
- 使用Mock模式进行离线测试
- 检查日志输出了解详细执行过程
- 利用可视化界面分析算法效果
- 通过参数调节优化处理质量

## 版本信息

- **版本**：v1.0
- **更新时间**：2025年9月30日
- **开发语言**：Python
- **图形界面**：PyQt5


