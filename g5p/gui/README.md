# 多层加工纠偏系统 v1.0

## 项目简介

本系统是一个完整的多层加工纠偏解决方案，支持逐层加工、偏差补偿累积、PLC通信和3D可视化。系统设计用于提高多层制造的精度，通过实时相机监测和智能纠偏算法，确保每一层的加工精度。

## 核心功能

### 1. 多层加工管理
- **逐层处理**：支持按层序加工，每层独立处理和纠偏
- **自动/手动模式**：可选择自动处理下一层或手动控制
- **进度跟踪**：实时显示加工进度和各层状态

### 2. 偏差补偿系统
- **第一层标定**：首层用于建立基准，记录固有偏差
- **累积补偿**：后续层应用前层偏差数据进行预补偿
- **误差防积累**：每层计算时先取消前层补偿，避免误差累积

### 3. PLC通信
- **TCP协议**：支持标准TCP Socket通信
- **S7协议**：支持西门子S7系列PLC通信
- **实时监控**：轮询获取当前层号和加工状态
- **双向通信**：读取控制信号，回写完成状态

### 4. 可视化分析
- **实时图像**：显示原始vs理论、纠偏后vs理论对比
- **统计分析**：有效率、偏差P95、平面内点率等指标
- **历史对比**：多层数据对比和趋势分析
- **3D轨迹**：理论、实际、纠偏轨迹的3D显示

### 5. 项目管理
- **配置保存**：项目配置、层数据、处理结果完整保存
- **结果导出**：支持CSV、G代码、图像等多格式导出
- **备份恢复**：自动备份和手动恢复功能

## 系统架构

```
多层加工纠偏系统
├── multilayer_main.py          # 主程序入口
├── multilayer_data.py          # 数据结构定义
├── multilayer_plc.py           # PLC通信模块
├── multilayer_processor.py     # 处理线程模块
├── multilayer_visualizer.py    # 可视化组件
├── multilayer_config.py        # 配置管理模块
├── run_multilayer_system.py    # 启动脚本
├── controller.py               # 原有控制器（复用）
├── align_centerline_to_gcode_pro_edit_max.py  # 原有算法（复用）
└── README.md                   # 本文档
```

## 依赖要求

### 必需依赖
```bash
pip install numpy opencv-python PyQt5
```

### 可选依赖
```bash
pip install python-snap7  # S7通信支持
```

### 硬件要求
- **相机**：支持Percipio深度相机（需要pcammls库）
- **PLC**：支持TCP或S7协议的可编程控制器
- **标定文件**：T_cam2machine.npy外参标定文件

## 快速开始

### 1. 启动系统
```bash
python run_multilayer_system.py
```

### 2. 项目配置
1. 设置项目名称和总层数
2. 配置PLC通信参数（如需要）
3. 加载G代码目录（每层一个文件）
4. 调整相机和算法参数

### 3. 开始加工
1. **手动模式**：点击"处理当前层"逐层处理
2. **自动模式**：启用"自动处理下一层"，系统自动进行
3. **PLC模式**：连接PLC后，系统根据PLC信号自动处理

### 4. 结果分析
- 在"当前层分析"选项卡查看实时结果
- 在"层管理"选项卡查看所有层状态
- 在"整体统计"选项卡查看趋势分析

## 工作流程

### 标准工作流程
1. **系统启动**：检查依赖，初始化相机
2. **项目创建**：新建或加载已有项目
3. **G代码加载**：扫描并加载各层G代码文件
4. **第一层标定**：
   - 处理第一层，不进行纠偏
   - 生成基准偏差补偿数据
   - 记录固有误差模式
5. **后续层纠偏**：
   - 应用前层偏差补偿
   - 检测实际中轴线
   - 生成纠偏数据（CSV + G代码）
   - 更新偏差补偿数据
6. **结果保存**：导出所有层的纠偏结果

### PLC集成工作流程
1. **PLC连接**：建立TCP或S7通信
2. **层号监控**：实时读取PLC当前层号
3. **自动触发**：层号变化时自动开始处理
4. **状态反馈**：处理完成后写入PLC完成信号

## 配置说明

### 项目配置
- **项目名称**：用于标识和保存项目
- **总层数**：预期加工的总层数
- **层厚**：每层的厚度（mm）
- **自动下一层**：是否自动处理下一层

### PLC通信配置
- **启用PLC通信**：是否使用PLC控制
- **通信类型**：TCP或S7协议
- **PLC IP**：PLC设备IP地址
- **端口**：通信端口号
- **层号地址**：PLC中存储当前层号的地址
- **开始信号地址**：PLC中的开始信号地址

### 算法配置
- **引导步长**：G代码重采样步长（mm）
- **搜索半宽**：法向搜索半宽度（mm）
- **平滑窗口**：偏差平滑窗口大小
- **最大偏移**：允许的最大偏移量（mm）
- **梯度限制**：相邻点偏差变化限制

## 数据格式

### 偏差补偿文件（bias_comp.json）
```json
{
  "version": "bias_comp/v1",
  "mode": "per_index",
  "guide_step_mm": 1.0,
  "n_points": 200,
  "timestamp": "2024-01-01 10:00:00",
  "gcode_path": "layer_01.gcode",
  "delta_bias_mm": [0.1, 0.2, 0.15, ...]
}
```

### 项目配置文件（project.json）
```json
{
  "project_name": "测试项目",
  "total_layers": 10,
  "layer_thickness_mm": 0.5,
  "use_plc": true,
  "plc_type": "tcp",
  "plc_ip": "192.168.1.100",
  "algorithm_config": {...}
}
```

## 故障排除

### 常见问题

1. **相机连接失败**
   - 检查pcammls库是否正确安装
   - 确认相机USB连接
   - 验证T_cam2machine.npy文件存在

2. **PLC通信失败**
   - 检查网络连接和IP地址
   - 确认PLC通信协议和端口
   - 验证S7库安装（如使用S7协议）

3. **处理失败**
   - 检查G代码文件格式
   - 确认相机视野覆盖加工区域
   - 调整算法参数（ROI、搜索范围等）

4. **偏差过大**
   - 重新标定相机外参
   - 检查机械精度
   - 调整平面拟合参数

### 调试模式
启动时添加`--debug`参数可以获得更详细的调试信息：
```bash
python run_multilayer_system.py --debug
```

## 扩展开发

### 添加新的PLC协议
1. 继承`PLCCommunicator`基类
2. 实现`connect`、`read_current_layer`等方法
3. 在主程序中注册新的通信器类型

### 自定义算法参数
1. 修改`multilayer_data.py`中的`ProjectConfig`
2. 在`controller.py`中对应调整参数传递
3. 更新UI界面的参数控件

### 增加可视化功能
1. 扩展`LayerVisualizationWidget`类
2. 添加新的图像处理和显示功能
3. 在主界面中集成新的可视化组件

## 版本历史

- **v1.0.0**（2024-01-01）
  - 初始版本发布
  - 支持多层加工纠偏
  - 集成PLC通信
  - 完整的GUI界面

## 技术支持

如需技术支持或报告问题，请提供以下信息：
- 系统版本和配置
- 详细的错误信息
- 重现问题的步骤
- 相关的日志文件

## 许可证

本项目采用MIT许可证，详见LICENSE文件。

---

**多层加工纠偏系统 v1.0**  
智能制造解决方案