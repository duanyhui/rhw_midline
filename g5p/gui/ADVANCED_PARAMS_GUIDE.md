# 多层加工纠偏系统 - 高级参数调节功能使用说明

## 功能概述

基于`simple_advanced_params.py`中的参数结构，为多层加工纠偏系统新增了丰富的高级参数调节功能。用户现在可以通过直观的中文界面调节相机参数、算法参数和系统参数，实现更精确的加工纠偏控制。

## 新增文件

- **multilayer_advanced_params.py** - 专为多层系统设计的高级参数调节对话框
- **test_advanced_params.py** - 高级参数功能验证测试脚本

## 功能特点

### 1. ROI投影参数调节
- **ROI模式选择**: none/camera_rect/machine/gcode_bounds
- **像素尺寸设置**: 控制顶视投影分辨率 (0.05-10.0mm/pixel)
- **边界扩展**: 确保完整覆盖工件 (0-100mm)
- **相机矩形ROI**: X,Y,宽,高像素坐标设置
- **机床坐标ROI**: 中心坐标和尺寸设置

### 2. 最近表面提取参数
- **平面展平算法**: 启用/禁用，RANSAC阈值和迭代次数
- **Z选择模式**: max(靠近相机)/min(靠近下方)
- **分位数设置**: 下分位数(0-50%)，上分位数(50-100%)
- **深度边界**: 相对参考层的厚度边界(0.1-50mm)
- **形态学处理**: 开运算、闭运算核大小，最小连通域

### 3. 法线可视化参数
- **法线显示**: 显示/隐藏法向采样线
- **箭头间距**: 偏差箭头抽样步长(1-200)
- **调试窗口**: 启用法线调试窗口
- **调试参数**: 步长、最大显示数、法线长度
- **文本标注**: 显示/隐藏Δn文本标注

### 4. 遮挡区域自定义
- **遮挡设置**: 启用/禁用遮挡区域处理
- **扩张距离**: 遮挡区域向外扩张距离(0-50mm)
- **多边形定义**: 支持自定义多边形顶点坐标
- **环带合成**: 在遮挡区域内按G代码合成环带掩模
- **环带半宽**: 自动估计或手动设置(0-100mm)

### 5. 引导中心线算法参数
- **基础参数**: 引导步长、搜索半宽、最大偏移
- **平滑参数**: 平滑窗口、曲率自适应、敏感度
- **梯度控制**: 最大梯度、最大缺口点数
- **拐角处理**: 启用拐角忽略、角度阈值、忽略半径

### 6. 多层特有参数
- **偏差补偿**: 启用/禁用，补偿文件路径设置
- **质量控制**: 最小有效率、最大P95偏差、平面内点率等
- **处理策略**: 自动下一层、处理延迟、最大重试次数

## 使用方法

### 启动高级参数调节

1. 在多层加工主界面点击 **"高级参数调节"** 按钮
2. 对话框将打开，显示6个选项卡的参数设置

### 参数调节流程

1. **选择参数类别**: 点击相应选项卡(ROI投影/最近表面/法线可视化等)
2. **调节参数值**: 根据tooltip提示调节各项参数
3. **预览效果**: 点击"预览效果"临时应用参数查看效果
4. **保存应用**: 点击"应用"保存更改并关闭对话框
5. **重置参数**: 如需恢复默认值，点击"重置"

### 预设管理

- **保存预设**: 点击"保存预设"将当前参数保存为JSON文件
- **加载预设**: 点击"加载预设"从文件恢复参数配置

## 参数生效验证

### 自动验证
- 参数应用后系统会显示成功消息
- 状态栏显示"高级参数已应用"
- 自动触发参数预览验证

### 手动验证
运行测试脚本验证功能：
```bash
python test_advanced_params.py
```

### 实际验证
1. 调节ROI投影参数后，在当前层处理中查看投影范围变化
2. 修改法线可视化参数后，观察显示效果变化
3. 调节引导中心线参数后，对比处理精度改善

## 参数调节建议

### ROI投影优化
- **像素尺寸**: 小值提高精度但增加计算量，大值降低精度但提速
- **边界扩展**: 根据工件大小适当设置，避免边缘数据丢失

### 算法参数调优
- **RANSAC阈值**: 工件平整时使用小值(0.5-1.0)，不平整时增大
- **引导步长**: 精细加工用小步长(0.5-1.0)，粗加工可用大步长
- **搜索半宽**: 根据预期偏差范围设置，通常3-8mm

### 质量控制设置
- **最小有效率**: 建议0.6-0.8，过低影响精度，过高可能误报
- **最大P95偏差**: 根据加工精度要求设置，通常5-15mm

## 故障排除

### 常见问题
1. **参数不生效**: 确保点击"应用"而非"预览效果"
2. **界面异常**: 重启应用程序重新加载参数
3. **预设加载失败**: 检查JSON文件格式和路径

### 调试方法
1. 运行测试脚本检查基本功能
2. 查看控制台输出的参数加载信息
3. 使用预览功能验证参数效果

## 技术实现

### 设计原则
- 基于`simple_advanced_params.py`的成熟参数结构
- 完全中文化界面，符合用户习惯
- 参数分类清晰，逻辑层次分明
- 实时预览功能，所见即所得

### 兼容性
- 兼容现有的controller.cfg参数体系
- 支持现有的simple_advanced_params功能
- 无缝集成到多层加工系统

### 扩展性
- 模块化设计，易于添加新参数
- 预设系统支持参数配置复用
- 标准化的参数验证和应用流程

---

**注意**: 此功能基于项目规范中的"高级参数调节界面规范"设计，提供独立的高级参数调节界面，通过按钮切换访问，包含ROI投影、最近表面提取、法线可视化、遮挡区域自定义和引导中心线等参数的分类调节功能。