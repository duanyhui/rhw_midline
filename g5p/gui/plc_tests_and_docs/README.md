# 多层加工纠偏系统 - PLC集成方案 

## 项目概述

本项目为多层加工纠偏系统实现了完整的西门子S7 PLC集成方案，支持通过snap7库进行实机联动，实现自动化的多层加工纠偏流程。

## 核心功能

### 1. S7协议通信
- 基于snap7库的西门子PLC通信
- 支持数据块（DB）读写操作
- 实时状态监控和心跳检测
- 连接故障自动恢复

### 2. 数据块结构设计
- **DB9044**: 控制和状态信息（512字节）
- **DB9045-DB9047**: 偏移数据存储（每个512字节）
- 支持2000+偏移点的分批传输
- 整数数据格式，支持浮点数缩放

### 3. 偏移数据处理
- 自动加载offset_table.csv文件
- 偏差过大检测和安全机制
- 数据过滤和插值修正
- 分批传输优化（每批384个点）

### 4. 安全机制
- 偏移量阈值检查（默认20mm）
- 梯度变化监控（默认0.5）
- 数据锁机制防止读写冲突
- 异常数据自动过滤

## 系统架构

```
多层加工纠偏系统
├── multilayer_main.py (主程序 - 已集成PLC功能)
├── s7_plc_enhanced.py (增强S7通信器)
├── plc_data_structures.py (PLC数据块定义)
├── offset_data_handler.py (偏移数据处理)
└── plc_tests_and_docs/ (测试和文档)
    ├── plc_simulator.py (PLC模拟器)
    ├── test_s7_communication.py (通信测试)
    └── README.md (本文档)
```

## 工作流程

1. **系统启动** → 连接PLC → 初始化数据块
2. **加载G代码** → 扫描多层G代码文件
3. **等待PLC信号** → 机床发送"正在执行第N层"信号
4. **检测完成信号** → PLC发送"本层完成"信号
5. **延时采图** → 等待配置的延时时间后开始图像处理
6. **算法处理** → 运行机器视觉算法生成纠偏数据
7. **安全检查** → 验证偏移数据是否在安全范围内
8. **分批传输** → 将纠偏数据分批写入PLC数据块
9. **等待下一层** → 重复步骤3-8直到所有层完成

## 快速开始

### 1. 环境准备

```bash
# 安装snap7库
pip install python-snap7

# 确保已安装PyQt5和其他依赖
pip install PyQt5 numpy opencv-python
```

### 2. 配置PLC连接

在主程序中设置PLC参数：
- **PLC IP**: 192.168.0.2 (根据实际情况修改)
- **通信类型**: 选择"s7"
- **数据块**: DB9044-DB9047 (确保PLC中已创建)

### 3. 启动模拟器测试

```bash
# 启动PLC模拟器
cd plc_tests_and_docs
python plc_simulator.py

# 运行通信测试
python test_s7_communication.py
```

### 4. 运行主程序

```bash
# 在gui目录下运行
python multilayer_main.py
```

## PLC数据块配置

### 控制数据块 (DB9044)

| 偏移地址 | 数据类型 | 说明 | 范围 |
|---------|----------|------|------|
| 0-1 | INT | 当前层号 | 1-100 |
| 2-3 | INT | 机床状态 | 0=空闲,1=加工中,2=等待,3=错误 |
| 4-5 | INT | 程序状态 | 0=未连接,1=已连接,2=处理中,3=完成 |
| 6-7 | INT | 总偏移点数 | 0-65535 |
| 8-9 | INT | 当前批次索引 | 0-255 |
| 10-11 | INT | 总批次数量 | 1-255 |
| 12-13 | INT | 数据锁状态 | 0=解锁,1=锁定 |
| 14-15 | INT | 处理延迟(ms) | 500-10000 |

### 偏移数据块 (DB9045-DB9047)

每个数据块存储128个偏移点：
- 每个偏移点占用4字节：dx(2字节) + dy(2字节)
- 数据格式：16位有符号整数
- 缩放因子：1000 (1mm = 1000)
- 取值范围：-32.767mm 到 +32.767mm

## 安全配置

### 偏差检测参数

```python
# 在offset_data_handler.py中配置
OffsetDataConfig(
    max_offset_mm=20.0,      # 最大允许偏移量
    max_gradient=0.5,        # 最大梯度变化
    max_invalid_ratio=0.1,   # 最大无效数据比例
    enable_safety_check=True, # 启用安全检查
    enable_filtering=True     # 启用数据过滤
)
```

### 数据传输安全

- 写入前检查数据锁状态
- 传输失败自动重试
- 异常偏移值自动过滤
- 梯度突变检测和修正

## 使用指南

### 1. 第一次使用

1. 确保PLC程序已配置相应的数据块
2. 验证网络连接和IP地址设置
3. 运行PLC模拟器进行初步测试
4. 执行通信测试验证功能

### 2. 日常操作

1. 启动主程序并连接PLC
2. 加载G代码目录
3. 启用PLC通信和自动下一层
4. 系统将自动响应PLC信号进行处理

### 3. 故障排除

**连接失败**：
- 检查网络连接和IP地址
- 验证PLC程序和数据块配置
- 确认snap7库安装正确

**数据传输错误**：
- 检查偏移数据是否在安全范围内
- 验证数据块大小和结构
- 查看详细错误日志

**处理超时**：
- 调整处理延迟时间
- 检查算法处理性能
- 验证图像采集设备状态

## 高级功能

### 1. 自定义处理流程

可以通过修改`multilayer_main.py`中的信号处理函数来自定义处理流程：

```python
def on_correction_request(self, layer_id: int):
    # 自定义处理逻辑
    pass
```

### 2. 扩展安全机制

在`offset_data_handler.py`中可以添加更多安全检查：

```python
def custom_safety_check(self, points):
    # 自定义安全检查逻辑
    pass
```

### 3. 数据可视化

系统已集成实时数据可视化，可以监控：
- 传输进度
- 偏移数据分布
- 处理时间统计
- 质量指标变化

## 技术支持

### 常见问题

**Q: snap7安装失败怎么办？**
A: 请参考snap7官方文档，确保正确安装了snap7核心库和Python绑定。

**Q: PLC连接不稳定怎么办？**
A: 检查网络质量，调整心跳间隔，启用连接重试机制。

**Q: 偏移数据精度不够怎么办？**
A: 调整缩放因子，使用更高精度的数据类型，或分多个字段存储。

### 开发参考

- [snap7官方文档](http://snap7.sourceforge.net/)
- [西门子S7协议规范](https://support.industry.siemens.com/)
- [PyQt5文档](https://www.riverbankcomputing.com/static/Docs/PyQt5/)

## 版本历史

- **v1.0** (2025-09-25): 初始版本，支持基本S7通信和数据传输
- 后续版本将根据实际使用反馈进行优化和扩展

## 许可证

本项目遵循项目原有许可证协议。

---

**注意**: 本文档描述的功能需要与实际的PLC程序配合使用。在生产环境中使用前，请充分测试所有功能的可靠性和安全性。