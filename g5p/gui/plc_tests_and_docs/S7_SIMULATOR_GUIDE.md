# S7 PLC网络模拟器使用指南

## 概述

新的S7网络模拟器是一个真正能够监听网络连接的PLC模拟器，支持与snap7客户端进行实际的网络通信。相比之前的版本，它提供了完整的网络服务器功能。

## 文件说明

### 主要文件
- `s7_network_simulator.py` - **新的网络模拟器（推荐使用）**
- `plc_simulator.py` - 原始模拟器（仅UI展示，无网络功能）
- `test_s7_communication.py` - 通信测试代码

## 快速开始

### 1. 启动S7网络模拟器

```bash
cd plc_tests_and_docs
python s7_network_simulator.py
```

### 2. 配置网络参数

- **监听IP**: `192.168.0.2` （默认，可修改）
- **监听端口**: `102` （S7协议标准端口）
- 点击"启动服务器"开始监听网络连接

### 3. 运行通信测试

在另一个终端中运行：

```bash
python test_s7_communication.py
```

### 4. 运行主程序测试

在主程序中设置：
- PLC类型：选择 "s7"
- PLC IP：输入 "192.168.0.2"
- 点击"连接PLC"

## 功能特性

### 网络服务器功能
- ✅ 真实的TCP网络监听
- ✅ 支持多客户端同时连接
- ✅ S7协议基础实现
- ✅ 数据块读写模拟
- ✅ 连接状态实时监控

### 数据管理
- ✅ 完整的PLC数据块模拟（DB9044-DB9047）
- ✅ 控制状态实时更新
- ✅ 偏移数据可视化
- ✅ 通信日志记录

### 测试功能
- ✅ 自动多层测试
- ✅ 机床状态模拟
- ✅ 数据交换统计
- ✅ 错误处理验证

## 使用步骤

### 第一次使用

1. **启动网络模拟器**
   ```bash
   python s7_network_simulator.py
   ```

2. **检查网络配置**
   - 确认IP地址设置（默认192.168.0.2）
   - 确认端口设置（默认102）
   - 点击"启动服务器"

3. **验证服务器状态**
   - 服务器状态显示"运行中"
   - 日志显示"S7模拟服务器监听: 192.168.0.2:102"

4. **运行测试**
   ```bash
   python test_s7_communication.py
   ```

5. **检查测试结果**
   - S7连接测试应该显示"通过"
   - 在模拟器中应该看到客户端连接日志

### 集成到主程序

1. **启动模拟器**（保持运行）

2. **配置主程序**
   - PLC类型：s7
   - PLC IP：192.168.0.2
   - 启用PLC通信

3. **连接测试**
   - 点击"连接PLC"
   - 检查连接状态
   - 观察模拟器日志

4. **功能验证**
   - 在模拟器中修改机床状态
   - 观察主程序响应
   - 测试数据传输

## 界面说明

### 左侧控制面板

#### 网络服务器配置
- **监听IP**: 服务器绑定的IP地址
- **监听端口**: 服务器监听端口（建议使用102）
- **启动/停止服务器**: 控制服务器运行状态
- **服务器状态**: 显示当前运行状态
- **连接客户端**: 显示当前连接的客户端数量

#### 机床状态控制
- **当前层号**: 模拟当前加工层（1-100）
- **机床状态**: 
  - 空闲：准备状态
  - 加工中：正在加工
  - 等待纠偏：等待算法程序发送纠偏数据
  - 错误：出现错误
  - 完成：加工完成
- **自动响应模式**: 启用自动处理客户端请求
- **应用状态**: 立即更新机床状态

#### 测试功能
- **开始多层自动测试**: 自动模拟多层加工流程
- **测试状态**: 显示当前测试进度

#### 连接信息
- 显示客户端连接和断开的详细信息

### 右侧数据面板

#### 控制数据块 (DB9044)
显示所有控制字段的实时值：
- current_layer: 当前层号
- machine_status: 机床状态
- program_status: 程序状态
- data_lock: 数据锁状态
- 等等...

#### 偏移数据块 (DB9045-9047)
显示三个偏移数据块的统计信息：
- 总点数和非零点数
- X/Y偏移范围
- 缩放因子

#### 通信日志
记录所有网络通信活动：
- 客户端连接/断开
- 数据读写操作
- 错误信息
- 状态变化

## 常见问题

### Q: 模拟器启动失败，提示"地址已被使用"
**A**: 端口102可能被其他程序占用
- 解决方案1: 修改端口为其他值（如1102）
- 解决方案2: 关闭占用端口的程序
- 检查命令: `netstat -an | findstr :102`

### Q: 客户端连接失败
**A**: 检查以下项目：
1. 模拟器是否已启动服务器
2. IP地址是否正确（注意不要使用127.0.0.1）
3. 防火墙是否阻止连接
4. snap7库是否正确安装

### Q: 测试显示"S7连接测试: 失败"
**A**: 按以下步骤排查：
1. 确认模拟器正在运行并显示"运行中"
2. 检查IP地址匹配（模拟器和测试代码）
3. 确认端口号正确（默认102）
4. 查看模拟器日志是否有连接请求

### Q: 数据传输不稳定
**A**: 可能的原因和解决方案：
1. 网络延迟：调整客户端超时设置
2. 并发连接：限制同时连接数
3. 数据量过大：检查传输的数据块大小

## 网络配置建议

### 开发环境
```
模拟器IP: 192.168.0.2
客户端IP: 192.168.0.100 (或其他)
端口: 102
子网掩码: 255.255.255.0
```

### 测试环境
```
模拟器IP: 10.0.0.2
客户端IP: 10.0.0.100
端口: 102
```

### 注意事项
- 不要使用127.0.0.1或localhost，可能导致snap7连接问题
- 确保网络中没有IP地址冲突
- 建议使用专用的测试网段

## 性能优化

### 服务器端优化
- 适当设置客户端超时时间（当前30秒）
- 限制最大并发连接数（当前5个）
- 定期清理断开的连接

### 客户端优化
- 设置合适的连接超时时间
- 实现重连机制
- 合理控制数据传输频率

## 调试技巧

### 查看详细日志
1. 启动模拟器后观察"通信日志"标签页
2. 每次连接、断开、数据交换都会记录
3. 可以清空日志重新开始观察

### 网络抓包
```bash
# 使用Wireshark抓包分析
# 过滤器：tcp.port == 102
```

### 手动连接测试
```python
import socket
s = socket.socket()
s.connect(('192.168.0.2', 102))
print("连接成功")
s.close()
```

## 扩展功能

### 添加更多数据块
在`S7ProtocolHandler`类中扩展：
```python
def handle_db_read(self, db_number, offset, size):
    if db_number == 9048:  # 新增数据块
        # 自定义处理逻辑
        pass
```

### 自定义协议处理
修改`process_request`方法以支持更多S7命令类型。

### 数据持久化
添加数据保存/加载功能，支持模拟器状态恢复。

## 技术支持

### 相关文档
- [snap7官方文档](http://snap7.sourceforge.net/)
- [S7协议规范](https://support.industry.siemens.com/)

### 故障排除
遇到问题时，请提供：
1. 模拟器日志信息
2. 客户端错误信息
3. 网络配置详情
4. 操作步骤描述

---

**重要提示**: 这个模拟器主要用于开发和测试，不应用于生产环境。在实际部署前，请充分测试所有功能的稳定性和安全性。