# S7 PLC模拟器系统说明

## 系统概述

S7 PLC模拟器是专为多层加工纠偏系统设计的测试工具，模拟西门子S7 PLC的数据块读写操作，用于测试主程序在真实S7通信环境下的表现。

## 文件结构

```
s7_simulator/
├── s7_plc_simulator.py          # 主模拟器程序（GUI界面）
├── s7_tcp_server.py             # TCP通信服务器
├── mock_s7_communicator.py      # S7通信客户端
├── s7_simulator_plc.py          # 主程序集成接口
├── start_s7_simulator.py        # 启动脚本
└── README.md                    # 本说明文档
```

## 数据块设计

### DB9044 - 控制状态数据块
| 地址 | 类型 | 名称 | 说明 |
|------|------|------|------|
| 0-1  | INT16 | 机床状态 | 0=idle, 1=running, 2=completed, 3=error |
| 2-3  | INT16 | 当前层号 | 当前正在处理的层号 |
| 4-5  | INT16 | 总层数 | 项目总层数 |
| 6-7  | INT16 | 处理锁 | 0=unlock, 1=locked |
| 8-9  | INT16 | 偏移点总数 | 当前层的偏移点数量 |
| 10-11| INT16 | 当前批次 | 当前传输的批次号 |
| 12-13| INT16 | 总批次数 | 总的传输批次数 |
| 14-15| INT16 | 数据就绪 | 0=not_ready, 1=ready |
| 16-17| INT16 | 心跳计数 | PLC心跳计数器 |
| 18-19| INT16 | 错误码 | 错误代码 |
| 20-21| INT16 | 处理延时 | 算法处理延时(ms) |

### DB9045-9047 - 偏移数据块
每个数据块存储128个偏移点：
- 每个偏移点占用4字节：dx(2字节) + dy(2字节)
- 数据单位：微米（μm）
- 数据格式：16位有符号整数，大端序

## 通信协议

### TCP通信
- **端口**: 8502
- **协议**: JSON over TCP
- **格式**: 长度前缀(4字节大端) + JSON数据

### 命令格式
```json
{
    "type": "connect|disconnect|db_read|db_write",
    "db_number": 9044,
    "start": 0,
    "size": 2,
    "data": "hex_string",
    "timestamp": 1234567890.123
}
```

### 响应格式
```json
{
    "status": "success|error",
    "data": "hex_string",
    "error": "error_message",
    "timestamp": 1234567890.123
}
```

## 使用方法

### 1. 启动S7模拟器
```cmd
cd s7_simulator
python start_s7_simulator.py
```

### 2. 配置主程序
1. 启动主程序
2. 选择PLC通信类型：`s7_sim`
3. 设置PLC IP：`127.0.0.1`
4. 点击"连接PLC"

### 3. 测试流程
在S7模拟器界面中：
1. 点击"开始当前层" - 模拟机床开始加工
2. 等待3秒后自动变为"completed"状态
3. 主程序检测到状态变化，触发算法处理
4. 观察偏移数据的接收和显示

## 安全机制

### 偏移量限制
- **最大偏移量**: 20mm
- **最大梯度**: 0.5mm/mm
- 超限时自动设为0或使用前值

### 数据验证
1. 偏移量幅值检查
2. 梯度变化检查
3. 数据格式验证
4. 通信完整性检查

## 主要功能

### 模拟器功能
- 可视化数据块监控
- 手动控制机床状态和层号
- 自动化测试流程
- 偏移数据接收显示
- 实时状态日志

### 通信功能
- 兼容snap7接口
- 自动重连机制
- 数据分批传输
- 处理锁机制
- 心跳监控

## 故障排除

### 连接问题
1. 检查端口8502是否被占用
2. 确保防火墙允许本地连接
3. 检查模拟器是否正常启动

### 数据问题
1. 检查偏移数据格式
2. 验证数据范围是否合理
3. 查看模拟器日志信息

### 通信问题
1. 检查JSON格式是否正确
2. 验证数据长度是否合理
3. 确认网络连接稳定

## 开发扩展

### 添加新数据块
1. 在`S7DataBlock`中定义新数据块
2. 更新GUI监控界面
3. 修改通信协议处理

### 自定义通信协议
1. 继承`MockS7Communicator`基类
2. 实现自定义读写逻辑
3. 更新服务器处理方法

## 注意事项

1. **端口冲突**: 确保8502端口未被占用
2. **数据格式**: 严格按照16位整数大端序格式
3. **安全限制**: 偏移数据会进行安全检查
4. **批次传输**: 大量数据自动分批传输
5. **处理锁**: 传输期间会锁定数据更新

## 测试建议

1. **基础连接**: 先测试连接和状态读取
2. **状态切换**: 测试机床状态的手动控制
3. **数据传输**: 测试偏移数据的接收和显示
4. **安全机制**: 测试超限数据的处理
5. **长时间运行**: 测试系统的稳定性

这个S7模拟器为主程序提供了完整的S7通信测试环境，确保在真实PLC部署前充分验证系统功能。