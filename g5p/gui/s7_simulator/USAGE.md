# S7 PLC模拟器使用指南

## 快速开始

### 1. 启动S7模拟器
```cmd
cd s7_simulator
python start_s7_simulator.py
```
或者双击 `start_simulator.bat`

### 2. 在主程序中配置
1. 启动主程序: `python multilayer_main.py`
2. 在PLC通信配置中：
   - 启用PLC通信：✓
   - 通信类型：选择 `s7_sim`
   - PLC IP：`127.0.0.1`
   - 端口：`502` (会自动连接到8502)
3. 点击"连接PLC"

### 3. 测试工作流程
在S7模拟器界面中：
1. 点击"开始当前层" → 状态变为 `running`
2. 等待3秒 → 自动变为 `completed`
3. 主程序检测到状态变化 → 触发算法处理
4. 观察"偏移数据"标签页中的数据接收情况
5. 点击"下一层"进入下一层测试

## 功能特点

### 数据块模拟
- **DB9044**: 控制状态（机床状态、层号、处理锁等）
- **DB9045-9047**: 偏移数据存储（每个128个偏移点）

### 安全机制
- 最大偏移量限制：20mm
- 梯度变化限制：0.5mm/mm
- 数据格式验证和范围检查

### 可视化监控
- 实时数据块内容显示
- 偏移数据接收预览
- 状态变化日志
- 原始数据十六进制视图

## 测试验证

运行测试脚本验证系统集成：
```cmd
python test_s7_simulator.py
```

## 故障排除

### 常见问题
1. **端口占用**: 确保8502端口未被占用
2. **连接失败**: 检查防火墙设置
3. **模块导入错误**: 确保在正确目录运行
4. **GUI启动失败**: 检查PyQt5是否安装

### 日志查看
- 模拟器界面的"状态日志"显示实时操作记录
- 主程序控制台显示通信详细信息

## 与真实PLC的差异

模拟器完全兼容主程序的S7通信接口，主要差异：
1. **连接方式**: 模拟器使用TCP JSON，真实S7使用snap7协议
2. **数据持久性**: 模拟器数据在重启后丢失
3. **响应时间**: 模拟器响应更快，无网络延迟

## 开发扩展

### 添加新功能
1. 修改 `S7PLCSimulator` 类添加新的数据处理逻辑
2. 在 `S7PLCSimulatorGUI` 中添加新的界面控件
3. 更新 `S7SimulatorTCPServer` 处理新的通信协议

### 自定义数据块
1. 在 `S7DataBlock` 中定义新数据块
2. 更新GUI界面显示新数据块内容
3. 修改通信协议支持新数据块操作

这个S7模拟器为您提供了完整的PLC通信测试环境，确保主程序在真实部署前得到充分验证。