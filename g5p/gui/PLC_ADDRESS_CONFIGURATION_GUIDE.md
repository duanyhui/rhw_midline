# PLC地址配置指南

## 层号地址详解

### 什么是层号地址？

**层号地址**（`current_layer_address`）是PLC数据块中存储当前加工层号的具体地址位置。该地址告诉算法系统从PLC的哪个位置读取当前正在加工的层号。

### 地址格式说明

#### S7协议地址格式
```
DB[数据块号].DB[数据类型][偏移地址]
```

**常用格式示例：**
- `DB1.DBD0` - 数据块1，双字（DWORD），偏移地址0
- `DB9044.DBW0` - 数据块9044，字（WORD），偏移地址0  
- `DB9044.DBD0` - 数据块9044，双字（DWORD），偏移地址0

**数据类型说明：**
- `DBX` - 位（Bit）
- `DBB` - 字节（Byte）
- `DBW` - 字（Word，16位）
- `DBD` - 双字（DWord，32位）

### 根据项目配置的推荐设置

根据项目记忆，本系统使用以下数据块：
- **DB9044** - 控制数据块
- **DB9045-DB9047** - 偏移数据块

#### 推荐的层号地址配置：

1. **标准配置**（推荐）
   ```
   层号地址: DB9044.DBW0
   ```
   - 使用控制数据块DB9044
   - 16位字类型，支持1-65535层
   - 偏移地址0（数据块开始位置）

2. **扩展配置**（大型项目）
   ```
   层号地址: DB9044.DBD0
   ```
   - 使用32位双字类型
   - 支持更大的层号范围

3. **自定义配置**
   ```
   层号地址: DB1.DBW10
   ```
   - 使用客户指定的数据块和偏移地址

### 如何填写层号地址

#### 场景1：使用项目标准配置
```
填入: DB9044.DBW0
说明: 在PLC控制数据块DB9044的偏移地址0处读取当前层号（16位字）
```

#### 场景2：PLC工程师指定地址
如果PLC工程师告诉您层号存储在：
- 数据块号：DB1
- 数据类型：WORD（16位）
- 偏移地址：20

```
填入: DB1.DBW20
说明: 在数据块DB1的偏移地址20处读取层号
```

#### 场景3：兼容现有PLC程序
如果现有PLC程序将层号存储在：
- 数据块号：DB100  
- 数据类型：DWORD（32位）
- 偏移地址：0

```
填入: DB100.DBD0
说明: 在数据块DB100的偏移地址0处读取层号
```

### PLC端对应配置

PLC工程师需要在相应位置存储当前层号：

#### Step 7 (TIA Portal) 配置示例
```pascal
// 在数据块DB9044中定义
DATA_BLOCK "Control_DB"
BEGIN
   current_layer : WORD := 1;      // 偏移地址 0.0
   machine_status : WORD := 0;     // 偏移地址 2.0  
   program_status : WORD := 0;     // 偏移地址 4.0
   // ... 其他控制数据
END_DATA_BLOCK
```

#### PLC程序逻辑示例
```pascal
// 在主程序中更新层号
CASE machine_state OF
    0: // 空闲状态
        "Control_DB".current_layer := next_layer_number;
    1: // 加工中
        "Control_DB".machine_status := 1;
    2: // 完成
        "Control_DB".current_layer := "Control_DB".current_layer + 1;
END_CASE;
```

### 配置验证方法

#### 1. 使用PLC模拟器测试
```bash
# 启动PLC模拟器
python start_interactive_plc.py

# 在主程序中测试连接
PLC IP: 127.0.0.1
端口: 502
层号地址: DB9044.DBW0
```

#### 2. 使用通信测试工具
```bash
# 运行通信测试
python test_plc_communication_complete.py
```

#### 3. 检查通信日志
查看控制台输出中的层号读取信息：
```
✓ PLC连接成功
当前层号: 1    # 这里应显示正确的层号
机床状态: idle
```

### 常见问题排查

#### Q1: 层号读取为0或异常值
**原因**: 地址配置错误或PLC端数据未初始化
**解决**: 
- 检查地址格式是否正确
- 确认PLC端对应地址有数据
- 验证数据类型是否匹配

#### Q2: 连接失败，提示地址无效
**原因**: 数据块不存在或权限不足
**解决**:
- 确认PLC中存在对应数据块
- 检查PLC访问权限设置
- 使用PLC编程软件验证数据块

#### Q3: 层号不更新
**原因**: PLC程序未更新层号或通信延迟
**解决**:
- 检查PLC程序逻辑
- 调整通信轮询频率
- 使用PLC在线监控工具验证

### 最佳实践建议

1. **标准化配置**
   - 使用项目推荐的DB9044.DBW0
   - 保持团队配置一致性

2. **文档记录**
   - 记录项目使用的具体地址配置
   - 与PLC工程师确认地址分配

3. **测试验证**
   - 总是先用模拟器测试
   - 现场连接前验证地址正确性

4. **错误处理**
   - 启用连接错误日志
   - 配置地址验证机制

### 相关文件说明

- `multilayer_data.py`: 包含ProjectConfig中的地址配置
- `s7_plc_enhanced.py`: 实现地址解析和数据读取
- `PLC_COMMUNICATION_GUIDE.md`: 详细通信协议说明
- `plc_tests_and_docs/`: 包含测试工具和示例

### 联系支持

如果在地址配置过程中遇到问题：
1. 查看详细的错误日志
2. 使用PLC模拟器进行离线测试  
3. 与PLC工程师确认地址分配方案
4. 参考项目标准配置文档