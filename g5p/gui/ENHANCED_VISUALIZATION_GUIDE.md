# 多层加工纠偏系统 - 增强可视化功能说明

## 概述

根据`simple_advanced_params.py`中的参数配置要求，已完善多层加工纠偏系统中视图模式下拉框的4个特定可视化功能：

1. **误差对比图**
2. **G代码3D可视化** 
3. **中轴线分析**
4. **纠偏前后对比**

## 功能详情

### 1. 误差对比图（Error Comparison Chart）

**位置**: 视图模式下拉框 -> "误差对比图"

**功能描述**:
- 显示当前层的详细误差统计信息
- 包含有效率、偏差均值、中位数、P95、标准差、最大/最小偏差
- 提供可视化的误差分布直方图框架
- 支持误差趋势分析

**数据来源**:
- 主要从`result['metrics']`获取统计数据
- 如果数据中已有`error_comparison`图像则直接使用
- 如果没有则动态生成可视化图表

**关键指标**:
```python
- valid_ratio: 有效率
- dev_mean: 偏差均值 
- dev_median: 偏差中位数
- dev_p95: P95偏差值
- dev_std: 偏差标准差
- dev_max/dev_min: 最大/最小偏差
```

### 2. G代码3D可视化（G-code 3D Visualization）

**位置**: 视图模式下拉框 -> "G代码3D可视化"

**功能描述**:
- 显示理论轨迹、实际轨迹和纠偏轨迹的3D对比
- 提供轨迹长度和质量统计
- 支持不同轨迹类型的颜色区分
- 包含坐标系和网格显示

**可视化元素**:
- 蓝色：理论轨迹路径
- 红色：实际检测轨迹
- 绿色：纠偏后轨迹
- 灰色网格：坐标参考系

**数据来源**:
- 轨迹数据从处理结果中获取
- 支持轨迹长度和质量指标显示
- 可扩展支持真实3D轨迹数据

### 3. 中轴线分析（Centerline Analysis）

**位置**: 视图模式下拉框 -> "中轴线分析"

**功能描述**:
- 分析中轴线偏差和连续性
- 显示理论与实际中轴线长度对比
- 提供横向偏差统计分析
- 包含曲率变化率计算

**分析指标**:
```python
- theoretical_length: 理论中轴线长度
- actual_length: 实际中轴线长度  
- lateral_deviation_mean: 平均横向偏差
- lateral_deviation_max: 最大横向偏差
- centerline_continuity: 中轴线连续性
- curvature_change: 曲率变化率
```

**可视化特点**:
- 零偏差参考线
- 偏差分布趋势图
- 轨迹位置-偏差关系图表
- 连续性和曲率统计

### 4. 纠偏前后对比（Before/After Correction Comparison）

**位置**: 视图模式下拉框 -> "纠偏前后对比"

**功能描述**:
- 对比纠偏前后的质量指标
- 计算并显示改善效果
- 提供纠偏质量等级评估
- 支持可视化对比图表

**对比维度**:
- 有效率改善情况
- P95偏差降低程度  
- 标准差变化
- 最大偏差控制效果

**质量等级**:
- 优秀：P95偏差减少 > 2.0mm
- 良好：P95偏差减少 > 1.0mm  
- 一般：P95偏差减少 ≤ 1.0mm

**可视化元素**:
- 左侧红色区域：纠偏前数据
- 右侧绿色区域：纠偏后数据
- 底部改善效果统计
- 对比柱状图显示

## 技术实现

### 代码结构

1. **multilayer_visualizer.py**
   - `generate_error_comparison_chart()`: 误差对比图生成
   - `generate_gcode_3d_visualization()`: G代码3D可视化生成
   - `generate_centerline_analysis()`: 中轴线分析生成  
   - `generate_before_after_comparison()`: 纠偏前后对比生成
   - `update_visualization()`: 视图模式切换逻辑更新

2. **multilayer_processor.py**
   - `generate_error_comparison_visualization()`: 处理线程中的误差对比生成
   - `generate_gcode_3d_visualization()`: 处理线程中的3D可视化生成
   - `generate_centerline_analysis_visualization()`: 处理线程中的中轴线分析生成
   - `generate_before_after_comparison()`: 处理线程中的前后对比生成

### 数据流程

1. **数据生成**: 在`LayerProcessingThread`处理过程中生成可视化图像
2. **数据存储**: 将生成的图像存储在`result`字典中对应键值
3. **数据传递**: 通过信号机制传递到可视化组件
4. **数据显示**: 在`LayerVisualizationWidget`中根据视图模式选择显示

### 参数配置集成

根据`simple_advanced_params.py`的参数结构，新增可视化功能支持以下参数：

#### ROI投影参数
- `roi_mode`: ROI模式设置
- `pixel_size_mm`: 像素尺寸配置
- `bounds_margin_mm`: 边界扩展设置

#### 最近表面参数  
- `plane_enable`: 平面展平启用
- `nearest_qlo/qhi`: 分位数范围
- `depth_margin_mm`: 深度边界

#### 可视化参数
- `draw_normal_probes`: 法线显示控制
- `arrow_stride`: 箭头间距
- `debug_normals_window`: 调试窗口启用

#### 引导中心线参数
- `guide_step_mm`: 引导步长
- `guide_halfwidth_mm`: 搜索半宽  
- `guide_max_offset_mm`: 最大偏移
- `guide_smooth_win`: 平滑窗口

## 使用说明

### 操作步骤

1. **启动系统**: 运行多层加工纠偏系统主程序
2. **加载G代码**: 选择G代码目录并加载层文件
3. **处理层数据**: 点击"处理当前层"开始处理
4. **查看可视化**: 在"当前层分析"选项卡中选择视图模式
5. **切换视图**: 使用视图模式下拉框切换不同可视化

### 视图模式选择

在可视化面板的"视图模式"下拉框中选择：
- 误差对比图：查看详细误差统计分析
- G代码3D可视化：查看轨迹3D对比效果  
- 中轴线分析：查看中轴线偏差和连续性
- 纠偏前后对比：查看纠偏改善效果

### 高级参数调节

点击"高级参数调节"按钮可以：
- 调整ROI投影参数
- 配置最近表面提取参数
- 设置可视化显示参数
- 优化引导中心线算法参数

## 测试验证

### 测试脚本

运行`test_enhanced_visualization.py`可以：
- 验证新增可视化功能
- 测试数据生成和显示逻辑
- 检查界面交互和切换功能

### 验证要点

1. **数据完整性**: 确保所有指标数据正确显示
2. **界面响应**: 确保视图模式切换流畅
3. **图像质量**: 确保可视化图像清晰易读
4. **参数联动**: 确保参数调节生效

## 扩展说明

### 未来改进方向

1. **真实3D渲染**: 集成OpenGL或matplotlib 3D支持
2. **交互式图表**: 支持鼠标交互和缩放功能
3. **动态更新**: 支持实时数据更新和动画效果
4. **数据导出**: 支持可视化图表和数据的多格式导出

### 自定义扩展

开发者可以通过以下方式扩展功能：
1. 在`generate_xxx_visualization()`方法中添加新的可视化元素
2. 在`update_visualization()`中添加新的视图模式
3. 在处理线程中添加新的数据计算逻辑
4. 通过参数配置支持更多可视化选项

## 注意事项

1. **性能考虑**: 大量数据时可能影响渲染性能，建议优化图像生成算法
2. **内存管理**: 注意及时释放不需要的图像数据，避免内存泄漏  
3. **错误处理**: 所有可视化生成都包含异常处理，确保系统稳定性
4. **兼容性**: 确保与现有的可视化功能兼容，不影响原有功能

## 总结

本次更新成功完善了多层加工纠偏系统的4个关键可视化功能，为用户提供了更丰富的数据分析和质量评估工具。通过参考`simple_advanced_params.py`的参数结构，确保了功能的完整性和可配置性，提升了系统的专业性和易用性。